import FormData from 'form-data';
import { createReadStream } from 'node:fs';
import { resolve } from 'node:path';
import { RELEASE } from '../../../constants/messages.js';

export const UPLOAD_ZIP_TO_CORVA_STEP = {
  message: RELEASE.uploadApp,
  /**
   *
   * @param {object} param0
   * @param {import('../../lib/api').Api} param0.api
   * @param {import('../../lib/manifest').Manifest} param0.manifest
   */
  fn: async ({ zipFileName, manifest, api, dirName }) => {
    const form = new FormData();

    form.append('package', createReadStream(resolve(dirName, zipFileName)), 'package.zip');

    const { id: packageId } = await api.uploadPackages(manifest.manifest.application.key, form);

    return { packageId };
  },
};
