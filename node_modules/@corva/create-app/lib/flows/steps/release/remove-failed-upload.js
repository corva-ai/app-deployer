import { resolve } from 'node:path';
import { unlink } from 'node:fs/promises';

export const REMOVE_FAILED_UPLOAD_STEP = {
  message: 'Cleaning up...',
  async fn({ api, appId, packageId, removeOnFail, uploadStatus, dirName, zipFileName, removeOnSuccess }) {
    if (uploadStatus === 'draft') {
      removeOnSuccess && (await unlink(resolve(dirName, zipFileName)));

      return;
    }

    if (removeOnFail) {
      await unlink(resolve(dirName, zipFileName));
      await api.deleteAppUpload(appId, packageId);
    }

    throw new Error(`Got unexpected status '${uploadStatus}' while processing package ${packageId}.`);
  },
};
