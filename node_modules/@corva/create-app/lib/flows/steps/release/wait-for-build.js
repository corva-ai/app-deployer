import debugFn from 'debug';
import { waitForMs } from '../../lib/waitForMs.js';

const debug = debugFn('cca:flow:release:step:wait-for-build');

const PROCESSING_STATUSES = ['pending', 'processing', 'queued', 'deploying'];

export const WAIT_FOR_BUILD_FINISH_STEP = {
  message: 'Wait till the app will process to draft status...',
  /**
   * @param {object} param0
   * @param {import('../../lib/api').Api} param0.api
   */
  async fn({ api, appId, packageId, progress }) {
    do {
      const { status } = await api.checkApp(appId, packageId);

      progress();

      debug(`Status: ${status}`);

      if (!PROCESSING_STATUSES.includes(status)) {
        return { uploadStatus: status };
      }

      await waitForMs(5000);
      // eslint-disable-next-line no-constant-condition
    } while (true);
  },
};
