const { RELEASE } = require('../../constants/messages');
const { promises: fs } = require('fs');
const dotenv = require('dotenv');
const { resolve } = require('path');
const { StepError } = require('../lib/step-error');

const GET_RELEASE_CONFIG_STEP = {
  message: RELEASE.getAuthToken,
  fn: async ({ dirName }) => {
    const env = await fs.readFile(resolve(dirName, '.env')).catch((e) => {
      if (e.code === 'ENOENT') {
        throw new StepError('Mising .env file', { cause: e });
      }

      throw e;
    });
    const { CORVA_API_ENV, AUTH_TOKEN } = dotenv.parse(env);

    if (!AUTH_TOKEN) {
      throw new StepError(RELEASE.getAuthTokenError);
    }

    return {
      CORVA_API_ENV: CORVA_API_ENV || 'production',
      AUTH_TOKEN,
    };
  },
};

module.exports = { GET_RELEASE_CONFIG_STEP };
