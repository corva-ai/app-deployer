'use strict';

const chalk = require('chalk');
const { SUCCESS_ICON } = require('./constants/messages');
const { resolve, sep } = require('path');

const debug = require('debug')('cca:flow');

const runFlow = async (flow, context, indent = '') => {
  process.stdout.write(
    `${indent}Running ${chalk.cyan(flow.name)} in ${chalk.cyan(resolve(context.dirName).split(sep).pop())}\n`
  );

  const result = await runSteps(flow.steps, context, indent + '  ');

  process.stdout.write(`${indent}Done!` + SUCCESS_ICON);

  return result;
};

const runSteps = async (steps = [], context = {}, indent = '') => {
  for (const step of steps) {
    if (step.name) {
      const result = await runFlow(step, context, indent);

      Object.assign(context, result);

      continue;
    }

    const message = indent + step.message;

    process.stdout.write(message);
    debug('Context: %o', context);

    const result = await step.fn(context);

    Object.assign(context, result);

    process.stdout.write(SUCCESS_ICON);
  }

  return context;
};

module.exports = { runFlow };
